# =========================================================
# .htaccess — Regalos Purranque
# Dominio canónico: https://regalospurranque.cl
# Actualizado: 2026-02-19
# =========================================================
RewriteEngine On

# ── 1) Forzar HTTPS (excepto localhost) ───────────────────────────────────
RewriteCond %{HTTPS} off
RewriteCond %{HTTP_HOST} !^localhost$ [NC]
RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# ── 2) Redirigir www.regalospurranque.cl → regalospurranque.cl ──────────────
RewriteCond %{HTTP_HOST} ^www\.regalospurranque\.cl$ [NC]
RewriteRule ^(.*)$ https://regalospurranque.cl/$1 [R=301,L]

# ── 3) Redirigir v2.regalos.purranque.info → regalospurranque.cl ────────────
RewriteCond %{HTTP_HOST} ^v2\.regalos\.purranque\.info$ [NC]
RewriteRule ^(.*)$ https://regalospurranque.cl/$1 [R=301,L]

# ── Front Controller ─────────────────────────────────────────────────────────
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^ index.php [L,QSA]

# ── Bloquear carpetas del framework ─────────────────────────────────────────
RewriteRule ^(app|config|storage|database|cron|deploy|views|legales|legal)/ - [F,L]

# ── MIME Types explícitos ───────────────────────────────────────────────────
# Necesario para que el servidor envíe Content-Type correcto a crawlers
# (Facebook, Twitter, WhatsApp, etc.)
<IfModule mod_mime.c>
    AddType image/jpeg .jpg .jpeg
    AddType image/png .png
    AddType image/webp .webp
    AddType image/gif .gif
    AddType image/svg+xml .svg
    AddType image/x-icon .ico
    AddType text/css .css
    AddType application/javascript .js
    AddType application/json .json
    AddType font/woff2 .woff2
    AddType font/woff .woff
    AddType application/xml .xml
</IfModule>

# ── Forzar Content-Type en imágenes (override servidor) ───────────────────
# HostGator puede ignorar AddType; Header set tiene mayor prioridad
<IfModule mod_headers.c>
    <FilesMatch "\.(?i:jpe?g)$">
        Header set Content-Type "image/jpeg"
    </FilesMatch>
    <FilesMatch "\.(?i:png)$">
        Header set Content-Type "image/png"
    </FilesMatch>
    <FilesMatch "\.(?i:gif)$">
        Header set Content-Type "image/gif"
    </FilesMatch>
    <FilesMatch "\.(?i:webp)$">
        Header set Content-Type "image/webp"
    </FilesMatch>
</IfModule>

# ── Headers de seguridad y optimización ─────────────────────────────────────
<IfModule mod_headers.c>
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "camera=(), microphone=(), geolocation=(self)"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://unpkg.com https://cdn.jsdelivr.net https://challenges.cloudflare.com; style-src 'self' 'unsafe-inline' https://unpkg.com; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://*.google-analytics.com https://*.googletagmanager.com https://challenges.cloudflare.com; frame-src https://challenges.cloudflare.com https://www.googletagmanager.com;"
    Header unset X-Powered-By
</IfModule>

# ── Bloquear archivos ocultos ───────────────────────────────────────────────
<FilesMatch "^\.">
    Require all denied
</FilesMatch>

# ── Bloquear archivos sensibles ─────────────────────────────────────────────
<FilesMatch "\.(sql|md|log|sh|bak|env|yml|yaml|lock|ini|php~)$">
    Require all denied
</FilesMatch>

# ── Bloquear scripts de desarrollo/debug accesibles desde raíz ─────────────
<FilesMatch "^(restaurar-backups|extractor-archivos|extractor-publico|rastreo-planes-validacion|ver-tildes|generate-assets|verificar-controller|testcorreo|diagnostico)\.php$">
    Require all denied
</FilesMatch>

# ── Permitir archivos públicos ──────────────────────────────────────────────
<FilesMatch "^(robots\.txt|sitemap\.xml|manifest\.json|favicon\.ico|sw\.js)$">
    Require all granted
</FilesMatch>

# ── Caché de assets estáticos ───────────────────────────────────────────────
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/webp "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"
    ExpiresByType image/x-icon "access plus 1 year"
    ExpiresByType text/css "access plus 1 week"
    ExpiresByType application/javascript "access plus 1 week"
    ExpiresByType font/woff2 "access plus 1 month"
</IfModule>

# ── Compresión Gzip ─────────────────────────────────────────────────────────
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/css application/javascript application/json image/svg+xml
</IfModule>
